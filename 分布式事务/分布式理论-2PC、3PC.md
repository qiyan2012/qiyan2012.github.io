---
title: 分布式理论-2PC、3PC
date: 2023-08-23 10:45:00
tags: 分布式
categories: 分布式
---

### 二阶段提交(2PC)

顾名思义，二阶段提交分为两个阶段。

+ 准备(prepare)阶段：事务协调者向各个参与者发送准备消息，等待各个参与者的响应。参与者收到消息后，执行事务操作，但并不会真正的提交。如果事务可以正常执行成功，返回YES，否则返回NO。
+ 提交(commit)阶段：事务协调者根据各个参与者的回复来决定是否提交事务，如果有任一个参与者返回NO或者等待超时，那么事务协调者会向各个参与者发出回滚(RollBack)请求。若全为YES，则向各个参与者发出提交(Commit)请求。



#### 2PC的缺点

1. ##### 长时间阻塞

   2PC的准备阶段，会执行事务操作，但不会真正的提交事务，这也就意味着资源可能被长时间的锁住，只有当事务协调者允许参与者提交后，资源才被释放。

2. ##### 事务协调者宕机导致阻塞

   若事务协调者出现故障，那么参与者就收不到事务协调者的二阶段的回馈，便会一直阻塞下去。

3. ##### 参与者宕机或网络抖动导致数据不一致

   分为两种情况

   + 第一阶段宕机：若该分布式事务需要A,B,C三个节点参与，第一阶段进行时：A,B已向事务协调者返回YES表示可以提交事务，C宕机或由网络抖动没收到。事务协调者等待C超时，使A,B回滚事务。
   + 第二阶段宕机：若该分布式事务需要A,B,C三个节点参与，且已顺利进入到第二阶段，此时C宕机。A，B已提交事务或已回滚事务，C因为宕机由网络抖动无法收到提交事务或回滚事务的请求，便会出现数据不一致现象。

   

### 三阶段提交(3PC)

在二阶段提交中，如果事务协调者长时间没有收到参与者的回应，便会认定为超时。但参与者没有超时机制，如果参与者锁定了资源，没有收到事务协调者的下一步指示，便会一直阻塞。

在三阶段提交中，参与者也引入了超时机制。这样就能避免2PC导致的资源被一直锁定



3PC分为三个步骤

+ CanCommit：事务协调者询问各个参与者是否可以执行事务操作，参与者若认为自己可以顺利的执行事务，则返回Yes，否则返回No。

+ preCommit： 事务协调者根据各个参与者的回复来决定是否提交事务，如果有任一个参与者返回NO或者等待超时，那么事务协调者会向各个参与者发出放弃(Abort)请求。若全为YES，则发送preCommit请求。

  若参与者收到放弃请求或超时未收到，则放弃事务操作。

  若参与者收到preCommit请求，便会执行事务操作，但不会提交。成功执行后会向事务协调者返回Ack。

+ 若事务协调者收到所有参与者的Ack，则向各个参与者发送doCommit请求，参与者收到后，会提交事务。否则发送Abort放弃请求，参与者收到后会回滚事务。

  如果参与者超时未收到事务协调者的请求，为了避免一直阻塞，会提交事务。

  

#### 3PC的缺点

  虽然参与者也引入了超时机制，但如果参与者超时未收到事务协调者的提交事务或放弃事务请求，就会主动提交事务，可能会导致数据不一致。



2PC和3PC都不能完美的解决分布式数据一致性问题。





