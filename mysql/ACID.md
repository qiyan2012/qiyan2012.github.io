



# ACID

ACID是衡量事务的四个特性

- 原子性：（Atomicity）
- 一致性：（Consistency）
- 隔离性：（Isolation）
- 持久性：（Durability）



### 原子性 Atomicity

#### 定义

原子性指：一个事务是一个不可分割的工作单位，其中的操作要么都做，要么都不做。

#### 实现原理

undo log

undo log是实现原子性的关键。`InnoDB`提供了`undolog`来记录insert、update、delete带来更新的逆向操作。

当事务回滚时可以通过undo log来撤销已执行的sql。



### 持久性 Durability

#### 定义

持久性指：事务一旦提交，对数据库的改变就是永久的。接下来的其他操作或故障不应该对其有任何影响。

#### 实现原理

redo log

`redolog`记录了对哪个表的哪个页的多少偏移量做了什么操作。

InnoDB通过预写日志来实现事物的持久化。详见：《Mysql的二阶段提交》一篇。

Mysql中一个页的大小默认为16KB。如果每次对数据进行修改，都要把把页刷新到磁盘，那么代价是非常大的。每次事务操作对数据的更新涉及到的记录可能在很多页，这也页可能并不相邻，随机I/O的代价也非常大。

但如果不把数据写入磁盘，如果宕机了，数据就丢失了。为了保证事务的`持久性`，`InnoDB`提供了`redolog`。



### 隔离性 Isolation

#### 定义

事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。对于隔离性的不同，区分了不同的隔离级别。

#### 实现原理

锁机制、MVCC

可以通过锁机制来解决两个事务之前写操作的相互影响。同一时刻只能有一个事务对数据进行写操作。

MVCC可以让事务的读操作不加锁，提升并发性能。MVCC可以实现多版本的数据共存。

> MVCC是靠隐藏列和undo log来实现的。

### 一致性 Consistency

一致性是指事务执行结束后，数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。数据库的完整性约束包括但不限于：实体完整性（如行的主键存在且唯一）、列完整性（如字段的类型、大小、长度要符合要求）、外键约束、用户自定义完整性（如转账前后，两个账户余额的和应该不变）。

如果数据库系统在运行过程中发生故障，有些事务尚未完成就被迫中断，这些未完成的事务对数据库所作的修改有一部分已写入物理数据库，这是数据库就处于一种不正确的状态，也就是不一致的状态



可以说，一致性是事务追求的最终目标：前面提到的原子性、持久性和隔离性，都是为了保证数据库状态的一致性。此外，除了数据库层面的保障，一致性的实现也需要应用层面进行保障。