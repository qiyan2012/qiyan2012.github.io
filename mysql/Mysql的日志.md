---
title: Mysql的日志-binlog、redolog、undolog、relaylog
date: 2023-08-25 13:10:00
tags: mysql
categories: mysql
---

## bin log

`binlog`是mysql本身的日志，当数据库发生变化时，binlog会记录数据库中的所有变化。主要用来主从复制和数据恢复。

+ 主从复制：从节点读取主节点的`binlog`，写到自己的`relay log`里。用于从节点同步主节点对数据库结构和数据的修改。
+ 数据恢复：通过`binlog`的起始位置和结束位置可以对mysql的数据进行恢复。如果有数据库的备份，那么从上次备份的位置到结束位置便可以恢复数据。

`binlog`格式有三种

+ `ROW`：记录哪条数据被修改了，修改多少条就有多少条的记录。对大量数据操作时，日志也会很多。

+ `STATMENT`：会记录SQL，但像`now()`等函数会导致数据不一致。

+ `MIXED`：混合模式，默认采用`STATMENT`，当涉及到`STATMENT`无法处理的函数操作时使用`ROW`模式。

## redo log

Mysql中一个页的大小默认为16KB。如果每次对数据进行修改，都要把把页刷新到磁盘，那么代价是非常大的。每次事务操作对数据的更新涉及到的记录可能在很多页，这也页可能并不相邻，随机I/O的代价也非常大。

但如果不把数据写入磁盘，如果宕机了，数据就丢失了。为了保证事务的`持久性`，`InnoDB`提供了`redolog`。

`redolog`会记录对哪个表的哪个页的多少偏移量做了什么操作。

`redolog`的刷盘是顺序I/O，按照产生的顺序写入磁盘。

> **随机IO**就是读写的内容分散在磁盘的不同位置，需要来回查找所以效率低；
> 
> **顺序IO**就是读写的内容集中存储在磁盘的一块，从前到后依次读取，免去了查找的过程，所以效率高。

## undo log

我们知道原子性指的是事务中的操作要么全部成功(事务提交)，要么全部失败(事务回滚)。

为了能够回滚事务，`InnoDB`提供了`undolog`来记录insert、update、delete带来更新的逆向操作。

由于有并发事务情况的存在，`undolog`会为`MVCC(多版本并发控制)`服务。当一个事务需要读取数据时，InnoDB 会根据该事务的隔离级别和`undolog`中的记录来确定应该返回哪个版本的数据。

如果事务提交，并且`MVCC`也不使用，那么`undolog`便会删除记录。

`undolog`保证了事物的`原子性`和`隔离性`

## relay log

主节点的读取`binlog`的日志发送到从节点，从节点会写到`relay log`里，从节点会启动线程从`relay log`读日志并应用修改，从而达到与主节点数据一致的目的。

在主从架构中，只需要从节点开启`relay log`即可

## bin log与redo log的区别

`binlog`是mysql server的；`redolog`是InnoDB的。

`binlog`是逻辑日志，记录id为多少的记录从什么改为什么或者记录sql；`redolog`是物理日志，记录哪个表的哪个页的多少偏移量做了什么修改

`binlog`用于数据同步，恢复；`redolog`用于故障时的数据恢复，保证事务的持久性。



